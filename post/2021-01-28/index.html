<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AWS MSK的安全性设置 - 心之所向</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Zhengguang Chen"><meta name=description content="如今设计大型软件系统的时候，异步和消息队列已经成了一种时尚。不管数据量大还是小，服务设计成异步总会看起来高大上一些。不要问，问就是设计容量一"><meta name=keywords content="个人,博客,技术"><meta name=generator content="Hugo 0.107.0 with theme even"><link rel=canonical href=https://blog.cerrorism.com/post/2021-01-28/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="AWS MSK的安全性设置"><meta property="og:description" content="如今设计大型软件系统的时候，异步和消息队列已经成了一种时尚。不管数据量大还是小，服务设计成异步总会看起来高大上一些。不要问，问就是设计容量一"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.cerrorism.com/post/2021-01-28/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-01-28T14:12:35-08:00"><meta property="article:modified_time" content="2021-01-28T14:12:35-08:00"><meta itemprop=name content="AWS MSK的安全性设置"><meta itemprop=description content="如今设计大型软件系统的时候，异步和消息队列已经成了一种时尚。不管数据量大还是小，服务设计成异步总会看起来高大上一些。不要问，问就是设计容量一"><meta itemprop=datePublished content="2021-01-28T14:12:35-08:00"><meta itemprop=dateModified content="2021-01-28T14:12:35-08:00"><meta itemprop=wordCount content="4907"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS MSK的安全性设置"><meta name=twitter:description content="如今设计大型软件系统的时候，异步和消息队列已经成了一种时尚。不管数据量大还是小，服务设计成异步总会看起来高大上一些。不要问，问就是设计容量一"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>心之所向</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>主页</li></a><a href=/post/><li class=mobile-menu-item>博客</li></a><a href=/about/><li class=mobile-menu-item>关于</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>心之所向</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>主页</a></li><li class=menu-item><a class=menu-item-link href=/post/>博客</a></li><li class=menu-item><a class=menu-item-link href=/about/>关于</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>AWS MSK的安全性设置</h1><div class=post-meta><span class=post-time>2021-01-28</span></div></header><div class=post-content><p>如今设计大型软件系统的时候，异步和消息队列已经成了一种时尚。不管数据量大还是小，服务设计成异步总会看起来高大上一些。不要问，问就是设计容量一个亿(小目标)。针对这种需求，AWS MSK成为了想使用Kafka作为消息队列，但又不想管理Kafka集群的公司的一个好选择。</p><p>相比AWS提供的其他消息队列服务，比如SQS、SNS、Kinesis之类，Kafka的优势是通用的API和大量的第三方文档（妈妈再也不用担心我被绑定在AWS上了）。但是Kafka的一个劣势是它目前没有和IAM很好的集成，安全性设置起来比较麻烦。</p><p>MSK的安全性分为两部分。首先是消息加密，保证了客户端只有使用适当的密钥才能解密查看接收到的信息。然后是基于证书的客户端验证，来保证只有特定的客户端才可以连接到Kafka集群。在这篇文章里，我们一步一步来配置安全的AWS MSK。</p><h2 id=创建aws-msk>创建AWS MSK</h2><p>首先，我们创建一个简单的MSK集群。这里，我们使用2.5.1版本，其他全默认。分配磁盘空间500G，大部分情况足够用了。不够再加，反正够便宜。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_msk_cluster&#34;</span> <span class=s2>&#34;msk_cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>cluster_name</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>team_name</span><span class=si>}</span><span class=s2>-msk-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>environment</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>kafka_version</span> = <span class=s2>&#34;2.5.1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>number_of_broker_nodes</span> = <span class=s2>&#34;3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>broker_node_group_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>instance_type</span> = <span class=s2>&#34;kafka.m5.xlarge&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>ebs_volume_size</span> = <span class=s2>&#34;500&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>az_distribution</span> = <span class=s2>&#34;DEFAULT&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=na>tags</span>   = <span class=nx>local</span><span class=p>.</span><span class=nx>common</span><span class=p>.</span><span class=nx>tags</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果我们只是想用一个简单的MSK集群，这样就够用了。可是，为了让这个Kafka集群可以在产品上使用，也就是所谓的“Product-Ready”，我们需要加入更多的配置，比如日志，比如监控，再比如无比重要的安全性。</p><p>首先就是监控。如果你运气好的话，公司里已经有可以和prometheus集成的监控系统了。如果没有的话，请出门左转Grafana（花点钱，花点……）。prometheus几乎要成为监控数据事实上的标准了，而AWS MSK在这方面的设置也是很简单的，暴露出来接口就好了。代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_msk_cluster&#34;</span> <span class=s2>&#34;msk_cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>open_monitoring</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>prometheus</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>jmx_exporter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=na>enabled_in_broker</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>node_exporter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=na>enabled_in_broker</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来，我们要把日志保存下来。必要的时候，最起码要知道自己是怎么挂掉的。这里，我们把日志保存在一个S3桶里。还是老样子，30天后自动删除。如果Kafka挂掉了30天后还没人发现，导致日志没了……那它死不死的也不是很重要了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_s3_bucket&#34;</span> <span class=s2>&#34;log-bucket&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>force_destroy</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=na>bucket</span>        = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>company_name</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>team_name</span><span class=si>}</span><span class=s2>-msk-log-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>environment</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>acl</span>           = <span class=s2>&#34;private&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>tags</span>          = <span class=nx>local</span><span class=p>.</span><span class=nx>common</span><span class=p>.</span><span class=nx>tags</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>lifecycle_rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>id</span>      = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>company_name</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>team_name</span><span class=si>}</span><span class=s2>-msk-log-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>environment</span><span class=si>}</span><span class=s2>-rule&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>enabled</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=nx>expiration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=na>days</span> = <span class=m>120</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_msk_cluster&#34;</span> <span class=s2>&#34;msk_cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>logging_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>broker_logs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>s3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=na>enabled</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>                <span class=na>bucket</span>  = <span class=nx>aws_s3_bucket</span><span class=p>.</span><span class=nb>log</span><span class=o>-</span><span class=nx>bucket</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>                <span class=na>prefix</span>  = <span class=s2>&#34;logs/msk-&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最后，我们加入一些Kafka本身的配置，比如是否允许删除Topic啦，是否允许自动创建Topic啦。这种东西和AWS没什么关系，如有疑问，出门左转Kafka自己的文档，我们这里就不详谈了。不过为了方便，我们这里配置客户端可以自由地增删Topic。自动管理嘛，我们只需要管好Kafka集群不出问题就好了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_msk_configuration&#34;</span> <span class=s2>&#34;msk_cluster_config&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>kafka_versions</span> = <span class=p>[</span><span class=s2>&#34;2.5.1&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>           = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>team_name</span><span class=si>}</span><span class=s2>-msk-config-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>environment</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>server_properties</span> = <span class=o>&lt;&lt;PROPERTIES</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>    auto.create.topics.enable = true
</span></span></span><span class=line><span class=cl><span class=s>    delete.topic.enable = true
</span></span></span><span class=line><span class=cl><span class=s>    </span><span class=o>PROPERTIES</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_msk_cluster&#34;</span> <span class=s2>&#34;msk_cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>configuration_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>arn</span> = <span class=nx>aws_msk_configuration</span><span class=p>.</span><span class=nx>msk_cluster_config</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl>        <span class=na>revision</span> = <span class=nx>aws_msk_configuration</span><span class=p>.</span><span class=nx>msk_cluster_config</span><span class=p>.</span><span class=nx>latest_revision</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=数据安全性---基于kms的数据加密>数据安全性 - 基于KMS的数据加密</h2><p>好了，开始我们的安全性表演。首先就是数据加密。我们在KMS上创建一个加密密钥，然后使用这个密钥来对数据进行加密。注意，我们的客户端需要有权限来得到这个密钥，否则当然是没法读取数据的。这一部分客户端权限的配置，我们在最后介绍客户端的时候再详细说。现在来看，我们就是用一个保存在KMS上的加密密钥来强行把Kafka的数据安全性和IAM验证捆绑起来。只要IAM是安全的，我们的客户端能正常的得到密钥，那么整个体系就能安全的运转。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_kms_key&#34;</span> <span class=s2>&#34;encrypt_key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>description</span>              = <span class=s2>&#34;KMS key for MSK&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>deletion_window_in_days</span>  = <span class=m>10</span>
</span></span><span class=line><span class=cl>    <span class=na>key_usage</span>                = <span class=s2>&#34;ENCRYPT_DECRYPT&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>customer_master_key_spec</span> = <span class=s2>&#34;SYMMETRIC_DEFAULT&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>enable_key_rotation</span>      = <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=na>tags</span>                     = <span class=nx>local</span><span class=p>.</span><span class=nx>common</span><span class=p>.</span><span class=nx>tags</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>请注意，首先我们开启了密钥自动更新（key_rotation）选项，也就是每隔一段时间我们就更新一下这个加密密钥。这样就算某一个密钥泄露了，也不会造成永久的伤害。KMS会保证记录下所有的历史密钥，所以不用担心密钥更新会导致服务不可用。另外，我们使用了对称加密（SYMMETRIC_DEFAULT），因为这是目前Kafka唯一支持的方式。</p><p>为了管理的方便，也便于我们在AWS网站上查看，我们给这个密钥一个别名。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_kms_alias&#34;</span> <span class=s2>&#34;encrypt_key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span>          = <span class=s2>&#34;alias/</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>team_name</span><span class=si>}</span><span class=s2>-msk-key-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>environment</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>target_key_id</span> = <span class=nx>aws_kms_key</span><span class=p>.</span><span class=nx>encrypt_key</span><span class=p>.</span><span class=nx>key_id</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最后，我们告诉MSK要用这个密钥来对数据进行加密。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_msk_cluster&#34;</span> <span class=s2>&#34;msk_cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>encryption_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>encryption_at_rest_kms_key_arn</span>  = <span class=s2>&#34;</span><span class=si>${</span><span class=nx>aws_kms_key</span><span class=p>.</span><span class=nx>encrypt_key</span><span class=p>.</span><span class=nx>arn</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>搞定，加密解密都是全自动的，只要配置好权限。这个叫做服务端加密（Server Side Encryption， SSE），非常方便。</p><h2 id=连接安全性---基于证书的客户端认证>连接安全性 - 基于证书的客户端认证</h2><p>连接的验证流程是这样的，客户端使用SSL协议连接，带上Kafka集群承认的证书，集群就会允许连接。具体的流程可以参照SSL的文档（我觉得很少有人有耐心看完那个文档，真的……）。简单来说，客户端通过证书代理（Certificate Agency）得到证书，集群通过同一个证书代理来验证证书的合法性。那么问题就简单了，让客户端和服务端都知道这个代理就好了。这不是巧了么，每个AWS的账户上都有一个根代理，图省事的话用那个就好了。如果要分离出来单独一个代理，那么就要使用AWS PCA来创建一个私有代理（Private Certificate Agency）。在一个公司中，创建代理这种一看就是“违法乱纪”的事情，一般我们不能自己动手。所以在下面的代码中，PCA是作为一个变量传进来的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_msk_cluster&#34;</span> <span class=s2>&#34;msk_cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>client_authentication</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tls</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=na>certificate_authority_arns</span>  = <span class=p>[</span><span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>acm_pca_arn</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>    
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>请注意，这里由于我们设置了TLS，那么这个集群就只允许SSL连接了，无比安全啊^_^。</p><p>在很多公司，创建证书这种事情是很麻烦的，有可能还需要和几个不同的安全组打交道。之后拿到了证书，又要小心翼翼的保存在安全的地方，因为证书相当于连接到集群所用的用户名密码，有了它就可以自由的连接到集群了。所以所有的保存密码的那一套麻烦事，都会一一的变成横列在我们面前的困难。这里，我们采取另一种方法，就是自动生成证书，并把证书放在一个S3桶里。这样客户端只要有权限从S3中下载证书，就可以连接到Kafka集群了。这样我们就把难以管理的证书问题，变成了有现成方法可依的IAM验证问题。</p><p>我们来创建用于保存证书的S3桶。为了安全起见，我们对S3中的对象进行加密，并且要求所有的存取文件操作都是加密的。加密使用的密钥我们依然使用与Kafka集群同一个密钥。我们也对对象的生命周期做一些配置，保证证书不会永久存在。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>data</span> <span class=s2>&#34;aws_iam_policy_document&#34;</span> <span class=s2>&#34;bucket_policy&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>effect</span> = <span class=s2>&#34;Deny&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>principals</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>type</span>        = <span class=s2>&#34;AWS&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>identifiers</span> = <span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=na>actions</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:PutObject&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>resources</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;arn:aws:s3:::</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>company_name</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>team_name</span><span class=si>}</span><span class=s2>-msk-certificate-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>environment</span><span class=si>}</span><span class=s2>/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>condition</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>test</span>     = <span class=s2>&#34;StringNotEquals&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>      variable</span> <span class=o>=</span> <span class=s2>&#34;s3:x-amz-server-side-encryption&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>values</span>   = <span class=p>[</span><span class=s2>&#34;aws:kms&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>effect</span> = <span class=s2>&#34;Deny&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>principals</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>type</span>        = <span class=s2>&#34;AWS&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>identifiers</span> = <span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=na>actions</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:PutObject&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>resources</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;arn:aws:s3:::</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>company_name</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>team_name</span><span class=si>}</span><span class=s2>-msk-certificate-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>environment</span><span class=si>}</span><span class=s2>/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>condition</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>test</span>     = <span class=s2>&#34;Null&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>      variable</span> <span class=o>=</span> <span class=s2>&#34;s3:x-amz-server-side-encryption&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>values</span>   = <span class=p>[</span><span class=s2>&#34;true&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_s3_bucket&#34;</span> <span class=s2>&#34;certificate-bucket&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>force_destroy</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=na>bucket</span>        = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>company_name</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>team_name</span><span class=si>}</span><span class=s2>-msk-certificate-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>environment</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>acl</span>           = <span class=s2>&#34;private&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>tags</span>          = <span class=nx>local</span><span class=p>.</span><span class=nx>common</span><span class=p>.</span><span class=nx>tags</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>server_side_encryption_configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>apply_server_side_encryption_by_default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>kms_master_key_id</span> = <span class=nx>aws_kms_key</span><span class=p>.</span><span class=nx>encrypt_key</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl>        <span class=na>sse_algorithm</span>     = <span class=s2>&#34;aws:kms&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>policy</span> = <span class=nb>data</span><span class=p>.</span><span class=nx>aws_iam_policy_document</span><span class=p>.</span><span class=nx>bucket_policy</span><span class=p>.</span><span class=nx>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>lifecycle_rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>id</span>      = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>company_name</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>team_name</span><span class=si>}</span><span class=s2>-msk-certificate-</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>environment</span><span class=si>}</span><span class=s2>-rule&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>enabled</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=na>abort_incomplete_multipart_upload_days</span> = <span class=m>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>expiration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>days</span> = <span class=m>732</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=创建用于连接的证书>创建用于连接的证书</h2><p>在很多公司，创建证书这种事情是很麻烦的，有可能还需要和几个不同的安全组打交道。之后拿到了证书，又要小心翼翼的保存在安全的地方，因为证书相当于连接到集群所用的用户名密码，有了它就可以自由的连接到集群了。所以所有的保存密码的那一套麻烦事，都会一一的变成横列在我们面前的困难。</p><p>那么，我们能不能用IAM来管理证书的生成和更新，从而把难以管理的证书问题，变成有现成方法可依的IAM验证问题呢？当然是可以的，事在人为嘛。我们把证书管理分成这么几步：</p><ol><li>每一次客户端要连接到Kafka集群上的时候，都去一个S3桶中检查一下是否存在已有的证书，并且检查一下证书是否过期了（比如检查证书对象的某个标签）。如果证书存在并且没有过期，那么下载下来用就好了。</li><li>如果证书不存在或者过期了，我们就要生成一个新的证书。这个可以使用一个单独的服务来做。<ol><li>通过调用AWS证书管理服务，我们创建一个证书。证书的有效期可以设置的短一些，比如十天半个月什么的。</li><li>然后将证书放进S3里，并使用一个约定好的键。顺便可以把有效期放进S3对象的标签里。</li></ol></li><li>生成好了证书后，就可以回到第1步并愉快的使用刚刚生成的证书了。</li></ol><p>最麻烦的其实是第2步，我们可以看一下代码是如何实现的。我们这里使用Kotlin来实现整个流程。我们最终的目的是创建一个KeyPair对象，并把它用特定的格式存进文件里，这样一个证书就完成了。</p><p>说起来简单，但事实上，恭喜你即将步入Java世界中最复杂的部分，JCA（Java Cryptograph Architecture）。复杂到连中文名我都懒得找了，因为整个架构真的不是很漂亮。整理流程是这样的：</p><ol><li>首先创建一个空白的KeyPair。</li><li>然后生成一个证书请求，这里我们需要指明我们的服务名称是什么，还有其他的一些拥有者信息。这个证书请求会随着最后创建的证书一起，保存在我们刚刚创建的KeyPair对象里。</li><li>将生成好的证书请求发给AWS的ACM-PCA服务来生成真正的证书。请注意这一步一般是异步的，也就是说请求发出去，过一段时间再去询问证书是否生成好了，之后才能下载下来证书。</li><li>将下载好的证书以X.509格式保存在第1步创建的KeyPair中，再将KeyPair保存在文件中。这个就是证书文件了。</li><li>最后我们将生成好的证书文件上传到S3上。</li></ol><p>首先是第一步，创建空白KeyPair的函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Kotlin data-lang=Kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>generateKeyPair</span><span class=p>():</span> <span class=n>KeyPair</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>keyGen</span> <span class=p>=</span> <span class=nc>KeyPairGenerator</span><span class=p>.</span><span class=n>getInstance</span><span class=p>(</span><span class=s2>&#34;RSA&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>keyGen</span><span class=p>.</span><span class=n>initialize</span><span class=p>(</span><span class=m>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>keyGen</span><span class=p>.</span><span class=n>genKeyPair</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>看起来平平无奇么，是的，这才刚开始，我们慢慢来。接下来是生成证书请求。为了简单，我们只提供一个信息，就是我们的服务名称是什么。这里我们需要服务名称作为参数，当然也需要我们之前生成的KeyPair对象。为了代码的简洁，我们使用了bouncycastle这个库（顺便推荐一下这个库，真的很好用，别看老了点，省了太多太多的事情）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Kotlin data-lang=Kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>generateCSR</span><span class=p>(</span><span class=n>x500DistinguishedName</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span> <span class=n>keyPair</span><span class=p>:</span> <span class=n>KeyPair</span><span class=p>):</span> <span class=n>String</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>p10Builder</span> <span class=p>=</span> <span class=n>JcaPKCS10CertificationRequestBuilder</span><span class=p>(</span><span class=n>X500Principal</span><span class=p>(</span><span class=n>x500DistinguishedName</span><span class=p>),</span> <span class=n>keyPair</span><span class=p>.</span><span class=k>public</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>signer</span> <span class=p>=</span> <span class=n>JcaContentSignerBuilder</span><span class=p>(</span><span class=n>signatureAlgorithm</span><span class=p>).</span><span class=n>build</span><span class=p>(</span><span class=n>keyPair</span><span class=p>.</span><span class=k>private</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>certRequest</span> <span class=p>=</span> <span class=n>p10Builder</span><span class=p>.</span><span class=n>build</span><span class=p>(</span><span class=n>signer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>listOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-----BEGIN CERTIFICATE REQUEST-----&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Base64</span><span class=p>.</span><span class=n>getEncoder</span><span class=p>().</span><span class=n>encodeToString</span><span class=p>(</span><span class=n>certRequest</span><span class=p>.</span><span class=n>encoded</span><span class=p>).</span><span class=n>chunked</span><span class=p>(</span><span class=m>64</span><span class=p>).</span><span class=n>joinToString</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-----END CERTIFICATE REQUEST-----&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>).</span><span class=n>joinToString</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来是生成证书了。这里我们调用AWS的PCA服务。除了函数的参数是我们上面生成的证书请求字符串，我们需要额外配置PCA的ARN，和签名的算法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Kotlin data-lang=Kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>awsAcmPca</span><span class=p>:</span> <span class=n>AWSACMPCA</span> <span class=p>=</span> <span class=nc>AWSACMPCAClient</span><span class=p>.</span><span class=n>builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>withRegion</span><span class=p>(</span><span class=n>region</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>pcaArn</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=s2>&#34;&lt;ARN-HERE&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>validityDays</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=m>60</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>csrSigningAlgorithm</span> <span class=p>=</span> <span class=s2>&#34;SHA256WITHECDSA&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>generateNewCertificate</span><span class=p>(</span><span class=n>csrStr</span><span class=p>:</span> <span class=n>String</span><span class=p>):</span> <span class=n>X509Certificate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>issueCertificateRequest</span> <span class=p>=</span> <span class=n>IssueCertificateRequest</span><span class=p>().</span><span class=n>apply</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>certificateAuthorityArn</span> <span class=p>=</span> <span class=n>pcaArn</span>
</span></span><span class=line><span class=cl>        <span class=n>csr</span> <span class=p>=</span> <span class=nc>ByteBuffer</span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>csrStr</span><span class=p>.</span><span class=n>toByteArray</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>signingAlgorithm</span> <span class=p>=</span> <span class=n>csrSigningAlgorithm</span>
</span></span><span class=line><span class=cl>        <span class=n>validity</span> <span class=p>=</span> <span class=n>Validity</span><span class=p>().</span><span class=n>withType</span><span class=p>(</span><span class=nc>ValidityPeriodType</span><span class=p>.</span><span class=n>DAYS</span><span class=p>).</span><span class=n>withValue</span><span class=p>(</span><span class=n>validityDays</span><span class=p>.</span><span class=n>toLong</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>awsAcmPca</span><span class=p>.</span><span class=n>issueCertificate</span><span class=p>(</span><span class=n>issueCertificateRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// wait for PCA processing cert request
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nc>Thread</span><span class=p>.</span><span class=n>sleep</span><span class=p>(</span><span class=m>5000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>getCertificateResult</span> <span class=p>=</span> <span class=n>awsAcmPca</span><span class=p>.</span><span class=n>getCertificate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>GetCertificateRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>withCertificateArn</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=n>certificateArn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>withCertificateAuthorityArn</span><span class=p>(</span><span class=n>pcaArn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>cf</span> <span class=p>=</span> <span class=nc>CertificateFactory</span><span class=p>.</span><span class=n>getInstance</span><span class=p>(</span><span class=s2>&#34;X.509&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cf</span><span class=p>.</span><span class=n>generateCertificate</span><span class=p>(</span><span class=n>getCertificateResult</span><span class=p>.</span><span class=n>certificate</span><span class=p>.</span><span class=n>byteInputStream</span><span class=p>())</span> <span class=k>as</span> <span class=n>X509Certificate</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>很好，我们已经生成了证书（并且是是最常用的X509Certificate格式），那么下面的函数可以把数据存在临时文件里。为什么是临时文件呢？因为我们最终是要把证书保存在S3上的，本地存在哪里就不重要了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Kotlin data-lang=Kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>saveCertificateToFile</span><span class=p>(</span><span class=n>certificate</span><span class=p>:</span> <span class=n>X509Certificate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>keystorePassword</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>keyPair</span><span class=p>:</span> <span class=n>KeyPair</span><span class=p>):</span> <span class=n>File</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>keyStoreFile</span> <span class=p>=</span> <span class=nc>File</span><span class=p>.</span><span class=n>createTempFile</span><span class=p>(</span><span class=s2>&#34;keyStore-&#34;</span><span class=p>,</span> <span class=s2>&#34;.jks&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>keyStore</span> <span class=p>=</span> <span class=nc>KeyStore</span><span class=p>.</span><span class=n>getInstance</span><span class=p>(</span><span class=n>keystoreType</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>keyStore</span><span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=k>null</span><span class=p>,</span> <span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>keyStore</span><span class=p>.</span><span class=n>setKeyEntry</span><span class=p>(</span><span class=n>alias</span><span class=p>,</span> <span class=n>keyPair</span><span class=p>.</span><span class=k>private</span><span class=p>,</span> <span class=n>keystorePassword</span><span class=p>.</span><span class=n>toCharArray</span><span class=p>(),</span> <span class=n>arrayOf</span><span class=p>(</span><span class=n>certificate</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>keyStoreFile</span><span class=p>.</span><span class=n>outputStream</span><span class=p>().</span><span class=n>use</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>keyStore</span><span class=p>.</span><span class=n>store</span><span class=p>(</span><span class=k>it</span><span class=p>,</span> <span class=n>keystorePassword</span><span class=p>.</span><span class=n>toCharArray</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>keyStoreFile</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最后，上传S3，搞定。注意，这个S3桶很重要，里面保存着的证书文件是我们Kafka集群重要的安全保证。所以，这个S3桶最好也开启SSE，保证数据进出都是加密过的。由于证书文件很小，所以我们也就不用什么多线程上传了，单个HTTP请求走起。上传的代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Kotlin data-lang=Kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>s3Client</span><span class=p>:</span> <span class=n>AmazonS3</span> <span class=p>=</span> <span class=n>AmazonS3ClientBuilder</span><span class=p>.</span><span class=n>standard</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>withRegion</span><span class=p>(</span><span class=n>region</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>sseKey</span> <span class=p>=</span> <span class=s2>&#34;&lt;Key-ARN&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>putCertificate</span><span class=p>(</span><span class=n>keystore</span><span class=p>:</span> <span class=n>File</span><span class=p>,</span> <span class=n>serviceName</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span> <span class=n>validityDays</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>tags</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>Tag</span><span class=p>(</span><span class=s2>&#34;createdDate&#34;</span><span class=p>,</span> <span class=nc>Instant</span><span class=p>.</span><span class=n>now</span><span class=p>().</span><span class=n>toString</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>                    <span class=n>Tag</span><span class=p>(</span><span class=s2>&#34;expiryDate&#34;</span><span class=p>,</span> <span class=nc>Instant</span><span class=p>.</span><span class=n>now</span><span class=p>().</span><span class=n>plus</span><span class=p>(</span><span class=n>validityDays</span><span class=p>.</span><span class=n>toLong</span><span class=p>(),</span> <span class=nc>ChronoUnit</span><span class=p>.</span><span class=n>DAYS</span><span class=p>).</span><span class=n>toString</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>objectKey</span> <span class=p>=</span> <span class=n>constructObjectKey</span><span class=p>(</span><span class=n>serviceName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>objectMetadata</span> <span class=p>=</span> <span class=n>ObjectMetadata</span><span class=p>().</span><span class=n>apply</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sseAlgorithm</span> <span class=p>=</span> <span class=nc>SSEAlgorithm</span><span class=p>.</span><span class=nc>KMS</span><span class=p>.</span><span class=n>algorithm</span>
</span></span><span class=line><span class=cl>        <span class=n>setHeader</span><span class=p>(</span><span class=nc>Headers</span><span class=p>.</span><span class=n>SERVER_SIDE_ENCRYPTION_AWS_KMS_KEYID</span><span class=p>,</span> <span class=n>sseKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>request</span> <span class=p>=</span> <span class=n>PutObjectRequest</span><span class=p>(</span><span class=n>bucketName</span><span class=p>,</span> <span class=n>objectKey</span><span class=p>,</span> <span class=n>keystore</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>withMetadata</span><span class=p>(</span><span class=n>objectMetadata</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>withTagging</span><span class=p>(</span><span class=n>ObjectTagging</span><span class=p>(</span><span class=n>tags</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>s3Client</span><span class=p>.</span><span class=n>putObject</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=证书生成所需要的iam角色>证书生成所需要的IAM角色</h2><p>我们来看看要生成证书，我们需要什么许可。</p><ul><li>首先当然是S3的存取对象了，当然还有一些辅助的操作，比如检索对象，给对象加标签等等。</li><li>然后是KEM相关的存取密钥的操作，这个主要是为了S3中文件的加密。</li><li>最后是ACM PCA的生成证书和获取证书两个操作</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>data</span> <span class=s2>&#34;aws_iam_policy_document&#34;</span> <span class=s2>&#34;generate-cert-policy-doc&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>actions</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:GetObject&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:PutObject&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:ListBucket&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:DeleteObject&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:ListBucketMultipartUploads&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:AbortMultipartUpload&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:PutObjectTagging&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>resources</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=nx>aws_s3_bucket</span><span class=p>.</span><span class=nx>certificate</span><span class=o>-</span><span class=nx>bucket</span><span class=p>.</span><span class=nx>arn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;</span><span class=si>${</span><span class=nx>aws_s3_bucket</span><span class=p>.</span><span class=nx>certificate</span><span class=o>-</span><span class=nx>bucket</span><span class=p>.</span><span class=nx>arn</span><span class=si>}</span><span class=s2>/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>actions</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:GetBucketLocation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:ListAllMyBuckets&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>resources</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>actions</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:GenerateDataKey*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:Encrypt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:Decrypt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:ReEncrypt*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:DescribeKey&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>resources</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=nx>aws_kms_key</span><span class=p>.</span><span class=nx>encrypt_key</span><span class=p>.</span><span class=nx>arn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>actions</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;acm-pca:IssueCertificate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;acm-pca:GetCertificate&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>resources</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>acm_pca_arn</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>至于客户端需要的权限就简单了，只需要S3的读取权限和KMS相关权限就好了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>data</span> <span class=s2>&#34;aws_iam_policy_document&#34;</span> <span class=s2>&#34;generate-cert-policy-doc&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>actions</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:GetObject&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:ListBucket&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>resources</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=nx>aws_s3_bucket</span><span class=p>.</span><span class=nx>certificate</span><span class=o>-</span><span class=nx>bucket</span><span class=p>.</span><span class=nx>arn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;</span><span class=si>${</span><span class=nx>aws_s3_bucket</span><span class=p>.</span><span class=nx>certificate</span><span class=o>-</span><span class=nx>bucket</span><span class=p>.</span><span class=nx>arn</span><span class=si>}</span><span class=s2>/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>actions</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:GetBucketLocation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;s3:ListAllMyBuckets&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>resources</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>actions</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:GenerateDataKey*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:Encrypt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:Decrypt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:ReEncrypt*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kms:DescribeKey&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>resources</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=nx>aws_kms_key</span><span class=p>.</span><span class=nx>encrypt_key</span><span class=p>.</span><span class=nx>arn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结</h2><p>好了，到此你就拥有了一个比较安全的Kafka集群了。要想进一步提升安全性，就要在网络上下功夫了，比如我们现在的kafka集群是在公网的，我们可以把它移动到我们自己的子网中，并设置适当的安全组。比如这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Terraform data-lang=Terraform><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_msk_cluster&#34;</span> <span class=s2>&#34;msk_cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>broker_node_group_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>        <span class=na>client_subnets</span> = <span class=p>[</span><span class=s2>&#34;&lt;subnet-1&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;&lt;subnet-2&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;&lt;subnet-3&gt;&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=na>security_groups</span> = <span class=p>[</span><span class=s2>&#34;&lt;security-group-1&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;&lt;security-group-2&gt;&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><nav class=post-nav><a class=prev href=/post/2021-01-29/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">在AWS上使用EMR创建一个简单的数据湖（3）</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/2021-01-26/><span class="next-text nav-default">在AWS上使用EMR创建一个简单的数据湖（2）</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=cerrorism@gmail.com class="iconfont icon-email" title=email></a>
<a href=https://linkedin.com/in/zhengguang-chen-a4a4b430 class="iconfont icon-linkedin" title=linkedin></a>
<a href=https://github.com/cerrorism class="iconfont icon-github" title=github></a>
<a href=https://www.zhihu.com/people/chen-zheng-guang class="iconfont icon-zhihu" title=zhihu></a>
<a href=https://space.bilibili.com/1614504 class="iconfont icon-bilibili" title=bilibili></a>
<a href=https://blog.cerrorism.com/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>Zhengguang Chen</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script>
<script src=/js/mermaid.min.js></script></body></html>